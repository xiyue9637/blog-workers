<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>渐变贴吧</title>
  <style>
    :root {
      --primary: #6a11cb;
      --secondary: #2575fc;
      --blur: 12px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: background 0.5s ease;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      min-height: 100vh;
      padding: 20px;
      color: #333;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      padding: 30px 0;
      margin-bottom: 30px;
    }
    
    h1 {
      font-size: 3.5rem;
      background: linear-gradient(to right, #fff, #e0e0e0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.2rem;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.85);
      border-radius: 20px;
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      padding: 25px;
      margin-bottom: 30px;
      overflow: hidden;
    }
    
    .card h2 {
      color: var(--primary);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(106, 17, 203, 0.2);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--primary);
    }
    
    input, textarea, select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.2);
    }
    
    button {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(106, 17, 203, 0.3);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 20px rgba(106, 17, 203, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .post {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      border-left: 4px solid var(--secondary);
    }
    
    .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 12px;
      border: 2px solid var(--secondary);
    }
    
    .author {
      font-weight: 600;
      color: var(--primary);
    }
    
    .post-title {
      font-size: 1.5rem;
      margin: 10px 0;
      color: #2c3e50;
    }
    
    .post-content {
      line-height: 1.6;
      color: #444;
      margin-bottom: 15px;
    }
    
    .comment {
      background: #f8f9fa;
      padding: 12px 15px;
      border-radius: 10px;
      margin-top: 10px;
      border-left: 3px solid var(--primary);
    }
    
    .comment-header {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .comment-author {
      font-weight: 600;
      color: var(--secondary);
      margin-right: 8px;
    }
    
    .comment-time {
      color: #777;
      font-size: 0.85rem;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn-delete {
      background: #ff4757;
      padding: 6px 12px;
      font-size: 0.9rem;
    }
    
    .auth-section {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .error {
      color: #ff4757;
      background: #ffeaa7;
      padding: 10px;
      border-radius: 8px;
      margin: 15px 0;
      display: none;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .tab {
      padding: 12px 25px;
      cursor: pointer;
      font-weight: 600;
      color: #777;
    }
    
    .tab.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @media (max-width: 768px) {
      h1 {
        font-size: 2.5rem;
      }
      
      .card {
        padding: 20px 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>渐变贴吧</h1>
      <p class="subtitle">一个丝滑流畅、实时模糊渐变的博客社区</p>
    </header>

    <div class="auth-section" id="authSection">
      <!-- 动态生成登录/注册/用户信息 -->
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="posts">全部帖子</div>
      <div class="tab" data-tab="create">发帖</div>
    </div>

    <div id="postsTab" class="tab-content active">
      <div class="card">
        <h2>最新帖子</h2>
        <div id="postsContainer">
          <!-- 帖子将动态加载到这里 -->
        </div>
      </div>
    </div>

    <div id="createTab" class="tab-content">
      <div class="card">
        <h2>发布新帖</h2>
        <div class="form-group">
          <label for="postTitle">标题</label>
          <input type="text" id="postTitle" placeholder="输入帖子标题">
        </div>
        <div class="form-group">
          <label for="postType">类型</label>
          <select id="postType">
            <option value="text">纯文字</option>
            <option value="图文">图文</option>
          </select>
        </div>
        <div class="form-group">
          <label for="postContent">内容</label>
          <textarea id="postContent" rows="6" placeholder="分享你的想法..."></textarea>
        </div>
        <button id="submitPost">发布帖子</button>
        <div class="error" id="postError"></div>
      </div>
    </div>

    <div id="registerModal" class="card" style="display:none;">
      <h2>注册账号</h2>
      <div class="form-group">
        <label for="regUsername">用户名</label>
        <input type="text" id="regUsername" placeholder="输入用户名">
      </div>
      <div class="form-group">
        <label for="regPassword">密码</label>
        <input type="password" id="regPassword" placeholder="输入密码">
      </div>
      <div class="form-group">
        <label for="regAvatar">头像直链 (可选)</label>
        <input type="url" id="regAvatar" placeholder="https://example.com/avatar.jpg">
      </div>
      <button id="registerBtn">注册账号</button>
      <div class="error" id="regError"></div>
      <p>已有账号? <a href="#" id="showLogin">去登录</a></p>
    </div>

    <div id="loginModal" class="card">
      <h2>登录账号</h2>
      <div class="form-group">
        <label for="loginUsername">用户名</label>
        <input type="text" id="loginUsername" placeholder="输入用户名">
      </div>
      <div class="form-group">
        <label for="loginPassword">密码</label>
        <input type="password" id="loginPassword" placeholder="输入密码">
      </div>
      <button id="loginBtn">登录</button>
      <div class="error" id="loginError"></div>
      <p>没有账号? <a href="#" id="showRegister">去注册</a></p>
    </div>
  </div>

  <script>
    // 全局状态
    const state = {
      token: localStorage.getItem('token'),
      username: localStorage.getItem('username'),
      role: localStorage.getItem('role'),
      avatar: localStorage.getItem('avatar')
    };

    // API 基础 URL (请替换为您的 Workers 地址)
    const API_BASE = 'https://your-worker-name.workers.dev/api';

    // DOM 元素
    const elements = {
      authSection: document.getElementById('authSection'),
      postsContainer: document.getElementById('postsContainer'),
      postTitle: document.getElementById('postTitle'),
      postType: document.getElementById('postType'),
      postContent: document.getElementById('postContent'),
      submitPost: document.getElementById('submitPost'),
      postError: document.getElementById('postError'),
      loginUsername: document.getElementById('loginUsername'),
      loginPassword: document.getElementById('loginPassword'),
      loginBtn: document.getElementById('loginBtn'),
      loginError: document.getElementById('loginError'),
      regUsername: document.getElementById('regUsername'),
      regPassword: document.getElementById('regPassword'),
      regAvatar: document.getElementById('regAvatar'),
      registerBtn: document.getElementById('registerBtn'),
      regError: document.getElementById('regError'),
      showRegister: document.getElementById('showRegister'),
      showLogin: document.getElementById('showLogin'),
      registerModal: document.getElementById('registerModal'),
      loginModal: document.getElementById('loginModal'),
      tabs: document.querySelectorAll('.tab'),
      tabContents: document.querySelectorAll('.tab-content')
    };

    // 初始化
    function init() {
      setupEventListeners();
      updateAuthUI();
      loadPosts();
      
      // 渐变动画
      setInterval(function() {
        var hue = Math.floor(Math.random() * 360);
        document.documentElement.style.setProperty('--primary', 'hsl(' + hue + ', 70%, 50%)');
        document.documentElement.style.setProperty('--secondary', 'hsl(' + ((hue + 60) % 360) + ', 70%, 50%)');
      }, 5000);
    }

    // 设置事件监听
    function setupEventListeners() {
      // 切换标签
      elements.tabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
          elements.tabs.forEach(function(t) {
            t.classList.remove('active');
          });
          tab.classList.add('active');
          
          var tabName = tab.getAttribute('data-tab');
          elements.tabContents.forEach(function(content) {
            content.classList.remove('active');
            if (content.id === tabName + 'Tab') {
              content.classList.add('active');
            }
          });
        });
      });

      // 登录
      elements.loginBtn.addEventListener('click', function() {
        var username = elements.loginUsername.value;
        var password = elements.loginPassword.value;
        
        if (!username || !password) {
          showError(elements.loginError, '请填写完整信息');
          return;
        }
        
        fetch(API_BASE + '/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: username, password: password })
        })
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          if (data.token) {
            state.token = data.token;
            state.username = username;
            state.role = data.role;
            state.avatar = data.avatar;
            
            localStorage.setItem('token', data.token);
            localStorage.setItem('username', username);
            localStorage.setItem('role', data.role);
            localStorage.setItem('avatar', data.avatar);
            
            updateAuthUI();
            clearError(elements.loginError);
            elements.loginUsername.value = '';
            elements.loginPassword.value = '';
          } else {
            showError(elements.loginError, data.error || '登录失败');
          }
        })
        .catch(function(error) {
          showError(elements.loginError, '网络错误，请重试');
        });
      });

      // 注册
      elements.registerBtn.addEventListener('click', function() {
        var username = elements.regUsername.value;
        var password = elements.regPassword.value;
        var avatar = elements.regAvatar.value;
        
        if (!username || !password) {
          showError(elements.regError, '请填写完整信息');
          return;
        }
        
        fetch(API_BASE + '/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            username: username, 
            password: password,
            avatar: avatar 
          })
        })
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          if (data.success) {
            alert('注册成功！请登录');
            elements.regUsername.value = '';
            elements.regPassword.value = '';
            elements.regAvatar.value = '';
            clearError(elements.regError);
            showLoginModal();
          } else {
            showError(elements.regError, data.error || '注册失败');
          }
        })
        .catch(function(error) {
          showError(elements.regError, '网络错误，请重试');
        });
      });

      // 发布帖子
      elements.submitPost.addEventListener('click', function() {
        var title = elements.postTitle.value;
        var content = elements.postContent.value;
        var type = elements.postType.value;
        
        if (!title || !content) {
          showError(elements.postError, '标题和内容不能为空');
          return;
        }
        
        fetch(API_BASE + '/posts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + state.token
          },
          body: JSON.stringify({ 
            title: title, 
            content: content, 
            type: type 
          })
        })
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          if (data.postId) {
            elements.postTitle.value = '';
            elements.postContent.value = '';
            clearError(elements.postError);
            loadPosts();
          } else {
            showError(elements.postError, data.error || '发帖失败');
          }
        })
        .catch(function(error) {
          showError(elements.postError, '网络错误，请重试');
        });
      });

      // 切换注册/登录模态框
      elements.showRegister.addEventListener('click', function(e) {
        e.preventDefault();
        showRegisterModal();
      });
      
      elements.showLogin.addEventListener('click', function(e) {
        e.preventDefault();
        showLoginModal();
      });
    }

    // 加载帖子
    function loadPosts() {
      fetch(API_BASE + '/posts')
        .then(function(response) {
          return response.json();
        })
        .then(function(posts) {
          var html = '';
          for (var i = 0; i < posts.length; i++) {
            var post = posts[i];
            html += '<div class="post">' +
              '<div class="post-header">' +
                '<img src="' + (post.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=default') + '" ' +
                     'alt="' + post.author + '" class="avatar">' +
                '<div>' +
                  '<div class="author">' + post.author + '</div>' +
                  '<div class="post-time">' + new Date(post.createdAt).toLocaleString() + '</div>' +
                '</div>' +
              '</div>' +
              '<h3 class="post-title">' + post.title + '</h3>' +
              '<div class="post-content">' + post.content + '</div>' +
              
              '<div class="controls">' +
                (state.username && (state.role === "admin" || state.username === post.author) ? 
                  '<button class="btn-delete" data-post-id="' + post.id + '">删除</button>' : '') +
              '</div>' +
              
              '<div class="comments">' +
                '<h4>评论 (0)</h4>' +
                '<div class="form-group" style="margin-top: 15px;">' +
                  '<textarea class="comment-input" placeholder="发表评论..." ' +
                            'data-post-id="' + post.id + '" rows="2"></textarea>' +
                  '<button class="submit-comment" data-post-id="' + post.id + '">评论</button>' +
                '</div>' +
              '</div>' +
            '</div>';
          }
          
          elements.postsContainer.innerHTML = html || '<p>还没有帖子，快来发布第一条吧！</p>';
          
          // 添加删除事件
          var deleteButtons = document.querySelectorAll('.btn-delete');
          for (var i = 0; i < deleteButtons.length; i++) {
            deleteButtons[i].addEventListener('click', function() {
              var postId = this.getAttribute('data-post-id');
              if (postId && !this.getAttribute('data-comment-id')) {
                // 删除帖子
                if (!confirm('确定要删除这个帖子吗？')) return;
                
                fetch(API_BASE + '/posts/' + postId, {
                  method: 'DELETE',
                  headers: { 'Authorization': 'Bearer ' + state.token }
                })
                .then(function(response) {
                  if (response.ok) {
                    loadPosts();
                  } else {
                    alert('删除失败');
                  }
                });
              }
            });
          }
          
          // 添加评论事件
          var commentButtons = document.querySelectorAll('.submit-comment');
          for (var i = 0; i < commentButtons.length; i++) {
            commentButtons[i].addEventListener('click', function() {
              var postId = this.getAttribute('data-post-id');
              var textarea = document.querySelector('.comment-input[data-post-id="' + postId + '"]');
              var content = textarea.value;
              
              if (!content) {
                alert('评论内容不能为空');
                return;
              }
              
              fetch(API_BASE + '/posts/' + postId + '/comments', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + state.token
                },
                body: JSON.stringify({ content: content })
              })
              .then(function(response) {
                if (response.ok) {
                  textarea.value = '';
                  loadPosts();
                } else {
                  alert('评论失败');
                }
              });
            });
          }
        })
        .catch(function(error) {
          elements.postsContainer.innerHTML = '<p>加载帖子失败，请刷新重试</p>';
        });
    }

    // 更新认证UI
    function updateAuthUI() {
      var html = '';
      
      if (state.token) {
        html = '<div class="user-info">' +
          '<img src="' + state.avatar + '" alt="' + state.username + '" class="avatar" style="width:40px;height:40px;">' +
          '<div>' +
            '<div>' + state.username + ' ' + (state.role === "admin" ? '(管理员)' : '') + '</div>' +
            '<button id="logoutBtn" style="margin-top:5px;padding:3px 10px;font-size:0.9rem;">退出</button>' +
          '</div>' +
        '</div>';
      } else {
        html = '<button id="loginBtnUI">登录</button>' +
               '<button id="registerBtnUI">注册</button>';
      }
      
      elements.authSection.innerHTML = html;
      
      if (!state.token) {
        elements.loginModal.style.display = 'block';
        elements.registerModal.style.display = 'none';
      } else {
        document.getElementById('logoutBtn').addEventListener('click', logout);
      }
      
      var loginBtnUI = document.getElementById('loginBtnUI');
      if (loginBtnUI) {
        loginBtnUI.addEventListener('click', showLoginModal);
      }
      
      var registerBtnUI = document.getElementById('registerBtnUI');
      if (registerBtnUI) {
        registerBtnUI.addEventListener('click', showRegisterModal);
      }
    }

    // 显示模态框
    function showLoginModal() {
      elements.loginModal.style.display = 'block';
      elements.registerModal.style.display = 'none';
    }
    
    function showRegisterModal() {
      elements.loginModal.style.display = 'none';
      elements.registerModal.style.display = 'block';
    }

    // 错误处理
    function showError(element, message) {
      element.textContent = message;
      element.style.display = 'block';
    }
    
    function clearError(element) {
      element.textContent = '';
      element.style.display = 'none';
    }

    // 退出登录
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      localStorage.removeItem('role');
      localStorage.removeItem('avatar');
      
      state.token = null;
      state.username = null;
      state.role = null;
      state.avatar = null;
      
      updateAuthUI();
      loadPosts();
    }

    // 初始化应用
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>